---
kind: Project
name: operator

variables:
  cluster-name: formance

environments:
  - name: default
    providers:
    - name: kubernetes
      setupIngressController: false
    varfile: .garden.env.yaml

providers:
  - name: kubernetes
    context: k3d-formance
    buildMode: kaniko
    kaniko:
      extraFlags: # TODO: Make optional registries flag
      - --registry-mirror=registry-docker-io:5000
      - --insecure-registry=registry-docker-io:5000
      - --force
      - --snapshotMode=redo
      - --use-new-run
    deploymentRegistry:
      hostname: internal-registry
      namespace: formancehq
      insecure: true
      port: 5000
---
kind: Module
name: operator-build-image
description: Operator build
type: container
include:
- pkg
- internal
- controllers
- apis
- main.go
- go.*
- Dockerfile
---
kind: Module
description: Update operator version
type: exec
name: operator-build-manifest
include:
- config
build:
  command:
  - >
    cd config/manager &&
    kustomize edit set image controller=internal-registry:5000/formancehq/operator-build-image:${modules.operator-build-image.version}
disabled: true
---
kind: Module
name: operator
description: Operator manifests
type: kubernetes
include:
- config
kustomize:
  path: config/default
dependencies:
- cert-manager
build:
  dependencies:
  - name: operator-build-image
  - name: operator-build-manifest
    copy:
    - source: config
      target: config
