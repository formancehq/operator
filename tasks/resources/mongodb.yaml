version: '3'

tasks:
  install:
    desc: Install MongoDB
    cmds:
    - helm repo add mongodb https://mongodb.github.io/helm-charts
    - helm upgrade --install community-operator mongodb/community-operator
    - task: "::cluster:apply"
      vars:
        MANIFEST: |
          ---
          apiVersion: mongodbcommunity.mongodb.com/v1
          kind: MongoDBCommunity
          metadata:
            name: mongodb
          spec:
            members: 1
            type: ReplicaSet
            version: "4.2.6"
            security:
              authentication:
                modes: ["SCRAM"]
            users:
              - name: root
                db: admin
                passwordSecretRef:
                  name: mongodb-root-password
                roles:
                  - name: clusterAdmin
                    db: admin
                  - name: userAdminAnyDatabase
                    db: admin
                  - name: readWriteAnyDatabase
                    db: admin
                scramCredentialsSecretName: my-scram
            additionalMongodConfig:
              storage.wiredTiger.engineConfig.journalCompressor: zlib
          # the user credentials will be generated from this secret
          # once the credentials are generated, this secret is no longer required
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: mongodb-root-password
          type: Opaque
          stringData:
            password: very-secured-password
